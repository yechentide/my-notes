# LANとWAN

LANとWANの区別は曖昧になってきたが、通信事業者が存在するかで判断するのが早い。

## ネットワークトポロジ

ネットワークを構築する際の雛形、テンプレート

### バス型トポロジ

- 基幹となるケーブルを一本敷設し、そこから支線を派生する
- あるノードの故障は他のノードに波及しない
- ノードの通信中は回線を独占してしまう
- ネットワーク構成を柔軟に変更できない

### スター型トポロジ (ハブ&スポーク型)

- 現在の主流のトポロジで、車輪のように中央のハブから何本のスポークが伸びているような形態
- ケーブル同士の関係は対等で、柔軟にネットワークを再構築できる
- ハブが故障した場合、それに接続したノードは全て通信ができなくなる

### リンク型トポロジ

- トークンパッシング方式を利用したもの
- ケーブルはリンク状に配置される
- ネットワーク上の通信衝突が発生しない
- １つのノードが故障すると、全てのノードの通信ができなくなる
- コンセントレータ
    - スター型のハブのような機器
    - リンク型をスター型のように取り扱える

### メッシュ型トポロジ

- 全てのノード間をケーブリングした形態
- 通信の衝突が発生しないし、迂回できるのでネットワーク全体の可用性が上がる
- ケーブリングが煩雑で、敷設も管理も非常に手間がかかる
- `フルメッシュ型トポロジ`: 全てのノードがお互いを結んでいる
- `パーシャルメッシュ型トポロジ`: フルメッシュ型トポロジ以外

## 物理層

- 同軸ケーブル
    - 中心の銅線が大口径で、その周りを絶縁体と塩化ビニールで保護する
    - ==**10BASE5**==: 伝送距離は500m、通信速度は10Mbps
    - ==**10BASE2**==: 伝送距離は185m、通信速度は10Mbps
- ツイストペア
    - 4本のより対線からなる銅線ケーブル
    - 規格によって4本のうちの2本しか使わないケースもある
    - ==**10BASE-T**==:    通信速度は 10   Mbps、ケーブルカテゴリ3   、より対線2本 (送信10Mbps、受信10Mbps)
    - ==**100BASE-TX**==:  通信速度は 100  Mbps、ケーブルカテゴリ5   、より対線2本 (送信100Mbps、受信100Mbps)
    - ==**1000BASE-T**==:  通信速度は 1000 Mbps、ケーブルカテゴリ5e  、より対線4本 (送受信250Mbps x4)
    - ==**1000BASE-TX**==: 通信速度は 1000 Mbps、ケーブルカテゴリ6   、より対線4本 (送信500Mbps x2、受信500Mbps x2)
    - ==**10GBASE-T**==:   通信速度は 10   Gbps、ケーブルカテゴリ6A/7、より対線4本 (送受信2.5Gbps x4)
    - オートネゴシエーション: 通信機器同志が互いの通信速度を自動検出して設定を同期させる機能
    - UTP: シールド未処理のツイストペアケーブル
    - STP: シールド処理されたツイストペアケーブル
    - FTP: Foiled Twisted Pair cable
    - Auto MDI/MDI-X
        - 通信環境を認識して、適切な設定を自動で行う技術
        - MDIタイプのポート: 送受信がストレート状態。例えばDTE(データ端末装置)
        - MDI-Xタイプのポート: 送受信がクロス状態。例えばDCE
- 光ファイバ
    - 金属テーブルは減衰によって長距離伝送ができなかったり伝送エラーなどを引き起こす
    - それに対して光ファイバは非常に伝送距離が長く、伝送品質も高い
    - シングルモード
        - 光ファイバのコア径が10μm程度
        - 原料として石英を使うので、高価で折り曲げに弱い
        - 長距離伝送や高速伝送が可能
    - マルチモード
        - 光ファイバのコア径が50μm程度
        - 原料はプラスチックで、安価で折り曲げに強い
        - 長距離・大容量伝送には向かない
- リピータ
    - 電流の増幅と信号整形のみを行う
    - 段数制限: あまりリピータを多段化させて使うと伝送の遅延が生じて、CSMA/CS方式のコリジョンをうまく検出できないための制限
        - スイッチングハブの使用により、気にする必要がなくなった
    - `リピータ → ハブ`: リピータハブ、マルチポートリピータ
        - 延長コードからマルチタップに進化したようなもの
    - `ハブ → スイッチングハブ`: ブリッジをマルチポート化したもの
        - 現在ではほとんどのネットワークでスイッチングハブが使われている

## データリンク層

### イーサネット

- IEEE 802.3として標準化されている
- イーサネットフレーム構成
    - PRE: 7バイト
        - 同期を取るための信号。1と0が交互に送信される
    - SFD: 1バイト
        - フレームの先頭であることを表すビットれる。`0b1010_1011`
    - DA: 6バイト
        - 宛先MACアドレス
    - SA: 6バイト
        - 送信元MACアドレス
    - LEN/TYPE: 2バイト
        - LENの場合はデータ部分の長さ
        - TYPEの場合は後続データ部分の上位層のプロトコルID (IPv4は`0x0800`)
    - DATA: 可変長
        - 最大で1500バイトなので、イーサネットのMTUが1500になっている
    - PAD: 可変長
        - フレームサイズが64バイト未満の場合、64バイトになるようにゼロ埋めする
    - FCS: 4バイト
        - CRCチェック用フィールド。対象はDA, SA, LEN/TYPE, DATA, PAD
    - IFG: 12バイト
- PoE (Power over Ethernet)
    - イーサネットケーブルで機器へ給電する技術
    - ==**IEEE802.3af規格: 15.4W /ポート**==(カテゴリ3以上)
    - ==**IEEE802.3at規格: 30W /ポート**==(カテゴリ5e以上)(PoE+)
    - 伝送路と電力路が同じのもの: 1, 2, 3, 6番ピンを使う
    - 伝送路と電力路が異なるもの: 4, 5, 7, 8番ピンを使う
    - 給電管理は==**給電側機器PSE**==(Power Sourcing Equipment)が行う
- ==**トークンパッシング**==
    - ネットワーク上にトークンと呼ばれる通信権を巡回させ、それを捉まえたノードだけがデータを送信できる方法
    - Free Token: 送信可能の状態
    - Busy Token: 送信不可の状態
- FDDI
    - 光ファイバで高速伝送を行うので、信頼性が高く、伝送距離が長い
    - 1次リングや2次リングで二重構成にできるが、費用がかかるため、実装では一部を一重構成で済ませている
- ==**TDMA**==
    - Time Division Multiplexing: 時分割多重
    - 時間によって伝送路の使用権を区切る
    - ケーブルの物理的伝送容量をいくつかの論理チャンネルに分割する
- ATM
    - 高速通信を主眼に設計されたプロトコル
    - ヘッダ5バイト、データ長48バイトに固定される
- ==**CSMA/CD**==
    - イーサネットで使われる伝送制御方式
    - CS(Carrier Sense): ネットワーク上でデータが流れていないかを確認する
    - MA(Multiple Access): 現在誰もネットワークを利用していないのであれば、誰でも送信して良い
    - CD(Collision Detection): たまたま複数ノードが同時送信した際はデータが壊されるので、それを検出して再送する
- ギガビットイーサネット(GbE)
    - 伝送速度が1000Mbps = 1Gbpsである通信規格の総称
    - 事実上CSMA/CDが使われていない
- GbE + ツイストペア
    - ==**1000BASE-T**==: IEEE802.3abで規格化、物理層の1000BASE-Tツイストペアケーブルを使用
        - 物理層の10BASE-Tや100BASE-TXの信号と互換性あり
    - 1000BASE-TX: 物理層の10BASE-Tや100BASE-TXの信号と互換性ないため、ほとんど使われていない
- GbE + 光ファイバー
    - ==**1000BASE-X**==: IEEE802.3zで規格化、光ファイバーを使用
    - ==**1000BASE-LX**==: 波長1310nm(長波長)のレーザを使った通信規格
        - 使用可能: ケーブル長550mのマルチモード光ファイバ
        - 主流: ケーブル長5000mのシングルモード光ファイバ (比較的に高コストなので、キャリアなどで利用される)
    - ==**1000BASE-SX**==: 波長850nm(短波長)のレーザを使った通信規格
        - 使用可能: ケーブル長550mのマルチモード光ファイバ
        - 低コストかつ短距離
        - スター型のトポロジを使って、企業内部接続の基幹部分に使われる
- GbE + 同軸ケーブル
    - 1000BASE-CX: 伝送距離は25mで、屋内配線向け。1000BASE-Tの普及により、ほとんど使われていない
- 10ギガビットイーサネット
    - 伝送速度が10Gbpsである通信規格の総称で、IEEE 802.3aeで規格化される
    - CSMA/CDが正式的に削除され、LANからリピータを排除し、全二重通信にした
    - 伝送速度から光ファイバを中心とした規格であるため、元々LANの規格であったが、長距離通信も可能
    - 用途によるカテゴライズ
        - 10GBASE-W: WAN向け
        - 10GBASE-R: LAN/MAN向け
        - 10GBASE-X: 回線を束ねて高速化したもの
    - 伝送距離によるカテコライズ
        - 10GBASE-Z: 80kmまで (1550nm長波長のレーザ)
        - 10GBASE-E: 40kmまで
        - 10GBASE-L: 10kmまで (1310nm長波長レーザ)
        - 10GBASE-S: 300mまで (850nm短波長レーザ)
    - 規格例
        - 10GBASE-SR: SかつRなので、構内通信向け規格
        - 10GBASE-LR: LかつRなので、企業の拠点間接続やキャリアのネットワークで採用される
        - 10GBASE-ZR: IEEE 802.3aeに記載のないベンダの拡張規格。長距離伝送向けで、80kmまでの距離を結べる
        - ==**10GBASE-T**==: IEEE 802.3anで標準化され、ツイストペアケーブルを使用
            - 特徴: 従来型のRJ-45が使えて、オートネゴシエーションで通信速度を自動設定できる
            - ツイストペア1対あたりで2.5Gbps x4 (ケーブルカテゴリ6A以上)
            - IEEE 802.3bzでは、ケーブルカテゴリ5e/6で5Gbpsの速度で伝送できるようにした

### データリンク層の接続機器

コリジョン = CSMA/CDにおける通信の衝突のこと  
コリジョンドメイン = コリジョンを検出できる範囲のこと  
ケーブルが長すぎたり、リピータの段数が多すぎたりすると、コリジョンを検出できなくなる  
コリジョンドメイン = セグメント

- ブリッジ
    - コリジョンドメインを分割して、正確にコリジョンを検出する
    - MACアドレスによって通信を制御する
    - 学習したMACアドレスとポートのペアを、MACアドレステーブルに保存する
    - ==**フィルタリング機能**==: 学習により無駄なトラフィックが発生しない
    - ==**ブロードキャストストーム**==: ループ構成となったネットワークで、通信データが永遠にループし続けること
    - ==**スパニングツリー (STP)**==
        - IEEE 802.1Dで定義されたループ解消方法
        - これに対応したブリッジは、一定間隔でBPDUパケットを交換して、ネットワーク構造を把握する
        - 重み付けによりルートを決定し、もう一方のルートにデータが流れなくなることで、ループを解消する
        - ルートブリッジは、ブリッジIDが小さいものが選ばれる
        - ブリッジID = プライオリティ値 + MACアドレス (まずはプライオリティ値で比べ、それが同じならMACアドレスで比べる)
        - ルートポート: 最小コストでルートブリッジに到達できるポート
        - 代表ポート: 各セグメントがルートブリッジに到達するために使われるポート
        - それ以外のポートは、通常運用時はブロッキングポートとしてブロックする
        - ツリーの再計算は最大で50秒かかる -> RSTP (Rapid Spanning Tree Protocol)で計算手順を変更して収束を速くする
    - MSTP (Multiple STP)
        - IEEE 802.1sで規格化され、後にIEEE 802.1Qへ統合された
        - VALNごとにツリーを作る代わりに、複数のVLANをインスタンスという単位にまとめて、計算の負荷を軽くする
- スイッチングハブ (L2スイッチ)
    - ブリッジと同様、MACアドレスを解釈して通信制御を行う
    - 旧来のリピータハブは、すべてのノードにトラフィックを流す
    - L2スイッチは、内部でスイッチング処理を行い、無駄な通信を他のノードに流さない
    - MACアドレスの学習はブリッジと同じ
    - 短所1: 単純な1対1通信において、オーバヘッド分だけハブよりスループットが低下
    - 短所2: 全ノードのパケットをListenする必要のある機器は、パケットの取得漏れが発生
    - Store & Forwardスイッチ: 転送フレームをすべてバッファに取り込み、FCSをチェックしてから転送する
    - カットスルースイッチ: 転送フレームをすべてバッファリングできていなくても、MACアドレスを認識できたら転送する
    - リンクアグリゲーション: 2つのスイッチを複数の物理回線で結び、回線を束ねて高速化したり可用性を上げたりできる (IEEE 802.3ad)

## ネットワーク層の接続機器

ブロードキャストドメイン = ネットワーク = IPブロードキャストが到達する範囲  

- ルータ
    - ブロードキャストドメインを分割して、トラフィックを管理する
    - IPアドレスによるフィルタリング操作ができるため、セキュリティ向上にもつながる
    - 経路制御 (ルーティング)
    - ファイアウォールとして使用する場合、ネットワーク層の機器だが、ポート番号を使うこともある
    - ファイアウォールとして使用する場合、フィルタリングルールの最後に「すべて拒否」を入れておくべき
    - VRRP (Virtual Router Redundancy Protocol)
        - 複数ルータを準備して、ルータを冗長化させるプロトコル
        - マスタルータ: 本番稼働させるルータ
        - バックアップルータ: 予備のルータ
        - 仮装IPを設定し、利用者はこの仮装IPと通信する
        - VRRPアドバタイズメント: マスタと予備の間で定期的に交換されるパケット。これで障害判定を行う
- L3スイッチ
    - ルータとほぼ同じだが、ソフトウェアではなく、ハードウェアで転送処理を行う
    - 通信制御に特化したハードを利用することで、高い処理能力を持つ -> 保持するポート数が多い
    - 小さなパケットを大量にやり取りするようなオーバヘッドの大きい通信に向いている
    - ルータよりもコストが低いが、処理の柔軟性に欠けることがある
    - ルータ: WAN/LANの境界に置かれる
    - L3スイッチ: 構内のLAN同士を接続する

## トランスポート層以上の接続機器

- ゲートウェイ
    - OSI基本参照モデルの第4層〜第7層のネットワークを接続する
    - プロトコル変換が主な用途 (キャリアごとのメールゲートウェイ、など)
    - セキュリティ対策としても使われる (ファイアウォール、プロキシサーバ)
- L4スイッチ
    - トランスポート層で稼働する、L2スイッチやL3スイッチの延長線上にある装置
    - TCP/UDPポート番号を経路制御の判断に使う
    - 負荷分散型のソリューションとして利用されることが多い (ロードバランサ)
    - パーシステンス: 同じユーザからの連続した通信を、同じサーバに転送する機能
- L7スイッチ
    - アプリケーション層までの情報を使って通信制御を行う
    - 主な目的は通信の転送で、専用ハードウェアによって処理される

## 無線LAN

- IEEE 802.11b: 11Mbps / 2.4Ghz
- IEEE 802.11a: 54Mbps / 5Ghz
- IEEE 802.11g: 54Mbps / 2.4Ghz
- IEEE 802.11n: 600Mbps / 2.4Ghz & 5Ghz (WiFi 4)
- IEEE 802.11ac: 6.9Gbps / 5Ghz (WiFi 5)
- IEEE 802.11ax: 9.6Gbps / 2.4Ghz & 5Ghz / OFDMA (WiFi 6)
